# WebApi - Documentación Técnica

## ?? Diagrama Cliente-Servidor

```
???????????????????????????????????????????????????????????????????????????????
?                              ARQUITECTURA                                    ?
???????????????????????????????????????????????????????????????????????????????
?                                                                              ?
?  ????????????????         HTTPS/REST          ????????????????????????????  ?
?  ?              ? ???????????????????????????? ?                          ?  ?
?  ?   CLIENTE    ?                              ?        SERVIDOR          ?  ?
?  ?  (Postman/   ?    JSON Request/Response     ?       (ASP.NET Core)     ?  ?
?  ?   Browser)   ?                              ?                          ?  ?
?  ?              ?         + JWT Token          ?                          ?  ?
?  ????????????????                              ????????????????????????????  ?
?                                                              ?               ?
?                                                              ?               ?
?                                                 ??????????????????????????   ?
?                                                 ?      SQL Server        ?   ?
?                                                 ?      (LocalDB)         ?   ?
?                                                 ?                        ?   ?
?                                                 ?  ???????????????????   ?   ?
?                                                 ?  ?   Users Table   ?   ?   ?
?                                                 ?  ???????????????????   ?   ?
?                                                 ?  ???????????????????   ?   ?
?                                                 ?  ? Products Table  ?   ?   ?
?                                                 ?  ???????????????????   ?   ?
?                                                 ??????????????????????????   ?
???????????????????????????????????????????????????????????????????????????????
```

---

## ?? Flujo de Autenticación JWT

```
???????????????????????????????????????????????????????????????????????????????
?                        FLUJO DE AUTENTICACIÓN JWT                            ?
???????????????????????????????????????????????????????????????????????????????
?                                                                              ?
?  CLIENTE                           SERVIDOR                    BASE DE DATOS?
?     ?                                  ?                            ?       ?
?     ?  1. POST /api/auth/login         ?                            ?       ?
?     ?  {username, password}            ?                            ?       ?
?     ? ??????????????????????????????   ?                            ?       ?
?     ?                                  ?  2. Validar credenciales   ?       ?
?     ?                                  ? ????????????????????????????       ?
?     ?                                  ?                            ?       ?
?     ?                                  ?  3. Usuario encontrado     ?       ?
?     ?                                  ? ????????????????????????????       ?
?     ?                                  ?                            ?       ?
?     ?                                  ?  4. Generar JWT Token      ?       ?
?     ?                                  ?     (Claims: username,     ?       ?
?     ?                                  ?      role, email)          ?       ?
?     ?                                  ?                            ?       ?
?     ?  5. Response: {token, user}      ?                            ?       ?
?     ? ??????????????????????????????   ?                            ?       ?
?     ?                                  ?                            ?       ?
?     ?  6. GET /api/products            ?                            ?       ?
?     ?  Header: Authorization:          ?                            ?       ?
?     ?          Bearer <token>          ?                            ?       ?
?     ? ??????????????????????????????   ?                            ?       ?
?     ?                                  ?  7. Validar Token          ?       ?
?     ?                                  ?     (Issuer, Audience,     ?       ?
?     ?                                  ?      Signature, Expiry)    ?       ?
?     ?                                  ?                            ?       ?
?     ?                                  ?  8. Verificar Role         ?       ?
?     ?                                  ?     (Authorization)        ?       ?
?     ?                                  ?                            ?       ?
?     ?  9. Response: {products[]}       ?                            ?       ?
?     ? ??????????????????????????????   ?                            ?       ?
?     ?                                  ?                            ?       ?
???????????????????????????????????????????????????????????????????????????????

ESTRUCTURA DEL TOKEN JWT:
???????????????????????????????????????????????????????????????????????????????
?  HEADER              ?  PAYLOAD                   ?  SIGNATURE              ?
???????????????????????????????????????????????????????????????????????????????
?  {                   ?  {                         ?  HMACSHA256(            ?
?    "alg": "HS256",   ?    "name": "admin",        ?    base64(header) +     ?
?    "typ": "JWT"      ?    "role": "Administrator",?    "." +                ?
?  }                   ?    "email": "admin@...",   ?    base64(payload),     ?
?                      ?    "exp": 1234567890,      ?    secret_key           ?
?                      ?    "iss": "WebApiIssuer",  ?  )                      ?
?                      ?    "aud": "WebApiAudience" ?                         ?
?                      ?  }                         ?                         ?
???????????????????????????????????????????????????????????????????????????????
```

---

## ?? Diagrama CRUD de Productos

```
???????????????????????????????????????????????????????????????????????????????
?                         OPERACIONES CRUD - PRODUCTOS                         ?
???????????????????????????????????????????????????????????????????????????????
?                                                                              ?
?  ??????????????????????????????????????????????????????????????????????????? ?
?  ?                              CREATE (POST)                               ? ?
?  ?  POST /api/products                                                      ? ?
?  ?  Body: { "name": "...", "description": "...", "price": 0.00 }           ? ?
?  ?  Rol: Administrator                                                      ? ?
?  ?  Response: 201 Created + ProductDto                                      ? ?
?  ??????????????????????????????????????????????????????????????????????????? ?
?                                      ?                                       ?
?                                      ?                                       ?
?  ??????????????????????????????????????????????????????????????????????????? ?
?  ?                               READ (GET)                                 ? ?
?  ?                                                                          ? ?
?  ?  GET /api/products                    GET /api/products/{id}            ? ?
?  ?  - Paginación: ?pageNumber=1&pageSize=10                                ? ?
?  ?  - Filtro: ?name=laptop                                                 ? ?
?  ?  - Ordenar: ?sortByPrice=asc|desc                                       ? ?
?  ?  Rol: Authenticated (User, Administrator)                               ? ?
?  ?  Response: 200 OK + PaginatedResponse<ProductDto>                       ? ?
?  ??????????????????????????????????????????????????????????????????????????? ?
?                                      ?                                       ?
?                                      ?                                       ?
?  ??????????????????????????????????????????????????????????????????????????? ?
?  ?                              UPDATE (PUT)                                ? ?
?  ?  PUT /api/products/{id}                                                  ? ?
?  ?  Body: { "name": "...", "description": "...", "price": 0.00 }           ? ?
?  ?  Rol: Administrator                                                      ? ?
?  ?  Response: 200 OK + ProductDto                                           ? ?
?  ??????????????????????????????????????????????????????????????????????????? ?
?                                      ?                                       ?
?                                      ?                                       ?
?  ??????????????????????????????????????????????????????????????????????????? ?
?  ?                             DELETE (DELETE)                              ? ?
?  ?  DELETE /api/products/{id}                                               ? ?
?  ?  Rol: Administrator                                                      ? ?
?  ?  Response: 200 OK + { deletedId }                                        ? ?
?  ??????????????????????????????????????????????????????????????????????????? ?
?                                                                              ?
???????????????????????????????????????????????????????????????????????????????
```

---

## ?? Explicación de Endpoints

### ?? Autenticación (`/api/auth`)

| Método | Endpoint | Descripción | Acceso | Request Body | Response |
|--------|----------|-------------|--------|--------------|----------|
| POST | `/api/auth/login` | Iniciar sesión | Público | `LoginRequestDto` | `LoginResponseDto` con JWT |
| POST | `/api/auth/register` | Registrar usuario | Público | `RegisterRequestDto` | `UserDto` |
| GET | `/api/auth/users` | Listar usuarios | Admin | - | `List<UserDto>` |
| GET | `/api/auth/profile` | Perfil del usuario actual | Autenticado | - | `UserDto` |

### ?? Productos (`/api/products`)

| Método | Endpoint | Descripción | Acceso | Query Params | Response |
|--------|----------|-------------|--------|--------------|----------|
| GET | `/api/products` | Listar productos | Autenticado | `pageNumber`, `pageSize`, `name`, `sortByPrice` | `PaginatedResponse<ProductDto>` |
| GET | `/api/products/{id}` | Obtener producto | Autenticado | - | `ProductDto` |
| POST | `/api/products` | Crear producto | Admin | - | `ProductDto` |
| PUT | `/api/products/{id}` | Actualizar producto | Admin | - | `ProductDto` |
| DELETE | `/api/products/{id}` | Eliminar producto | Admin | - | `{ deletedId }` |

---

## ??? Estructura del Proyecto

```
WebApi/
??? Controllers/
?   ??? AuthController.cs       # Autenticación y usuarios
?   ??? ProductsController.cs   # CRUD de productos
??? Data/
?   ??? AppDbContext.cs         # Contexto de Entity Framework
??? DTOs/
?   ??? ProductDto.cs           # DTOs de productos
?   ??? UserDto.cs              # DTOs de usuarios
?   ??? PaginationDto.cs        # DTOs de paginación y respuesta
??? Middleware/
?   ??? ExceptionHandlingMiddleware.cs  # Manejo global de errores
?   ??? RequestLoggingMiddleware.cs     # Logging de requests
??? Migrations/
?   ??? ...                     # Migraciones de EF Core
??? Models/
?   ??? Products.cs             # Entidad Producto
?   ??? UserModel.cs            # Entidad Usuario
??? Services/
?   ??? JwtService.cs           # Servicio de generación de tokens
??? appsettings.json            # Configuración
??? Program.cs                  # Punto de entrada
```

---

## ?? Seguridad por Roles

| Rol | Permisos |
|-----|----------|
| **User** | Consultar productos (GET) |
| **Administrator** | Consultar + Crear + Actualizar + Eliminar productos, Ver lista de usuarios |

---

## ?? Códigos de Respuesta HTTP

| Código | Significado | Uso |
|--------|-------------|-----|
| 200 | OK | Operación exitosa |
| 201 | Created | Recurso creado |
| 400 | Bad Request | Datos de entrada inválidos |
| 401 | Unauthorized | Token JWT inválido o expirado |
| 403 | Forbidden | Sin permisos para la acción (rol insuficiente) |
| 404 | Not Found | Recurso no encontrado |
| 500 | Internal Server Error | Error del servidor |

---

## ?? Ejemplos de Uso en Postman

### 1. Login
```http
POST http://localhost:5200/api/auth/login
Content-Type: application/json

{
    "username": "admin",
    "password": "123456"
}
```

### 2. Obtener productos con paginación y filtro
```http
GET http://localhost:5200/api/products?pageNumber=1&pageSize=10&name=laptop&sortByPrice=asc
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
```

### 3. Crear producto (solo Admin)
```http
POST http://localhost:5200/api/products
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...

{
    "name": "Laptop Gaming",
    "description": "Laptop para juegos de alta gama",
    "price": 2500.00
}
```
